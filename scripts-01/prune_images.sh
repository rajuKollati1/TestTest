#!/bin/bash

# ===============================
# ContainerD Image Prune Script
# ===============================

# Configurable threshold
THRESHOLD=70

# Interactive prompt
read -p "Enter the worker node IP or hostname: " NODE
read -p "Enter SSH username (default: root): " USER
USER=${USER:-root}

# Check disk usage on the worker node
echo "Checking disk usage on $NODE..."
USAGE=$(ssh "$USER@$NODE" "df -h / | awk 'NR==2 {print \$5}' | sed 's/%//'")

if [ -z "$USAGE" ]; then
    echo "‚ùå Error: Unable to retrieve disk usage. Check SSH connection or permissions."
    exit 1
fi

echo "‚úÖ Disk usage on $NODE is $USAGE%."

if [ "$USAGE" -ge "$THRESHOLD" ]; then
    echo "‚ö†Ô∏è Disk usage is above $THRESHOLD%. Proceeding with ContainerD image pruning..."

    ssh "$USER@$NODE" bash << 'EOF'
        # Decide whether to use sudo
        SUDO=""
        if [ "$(id -u)" -ne 0 ]; then
            if command -v sudo &>/dev/null; then
                SUDO="sudo"
            else
                echo "‚ùå Error: Not running as root and sudo not available."
                exit 1
            fi
        fi

        # Verify ctr command
        if ! $SUDO ctr version &>/dev/null; then
            echo "‚ùå Error: ContainerD (ctr) command not found. Aborting."
            exit 1
        fi

        echo "üìã Listing unused ContainerD images..."
        $SUDO ctr images list | grep -v 'TAG' | awk '{print $1}' > /tmp/all_images.txt

        echo "üìã Listing used images from running containers..."
        $SUDO ctr containers list | awk '{print $2}' > /tmp/used_images.txt

        echo "üìã Identifying unused images..."
        grep -vxFf /tmp/used_images.txt /tmp/all_images.txt > /tmp/unused_images.txt

        echo "üóëÔ∏è Pruning unused images..."
        while read -r image; do
            if [ -n "$image" ]; then
                echo "   ‚Üí Removing image: $image"
                $SUDO ctr images remove "$image"
            fi
        done < /tmp/unused_images.txt

        echo "‚úÖ Pruning complete."
        $SUDO rm -f /tmp/all_images.txt /tmp/used_images.txt /tmp/unused_images.txt
EOF

else
    echo "‚úÖ Disk usage is below threshold ($THRESHOLD%). No pruning needed."
fi
